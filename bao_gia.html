<!DOCTYPE html>
<html>
<head>
    <title>BÁO GIÁ VẬT TƯ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS CHUNG & BỐ CỤC */
        body { background-color: #fff; margin: 0; padding: 0; font-family: 'Times New Roman', Times, serif; font-size: 11pt; }
        .page { width: 21cm; min-height: 29.7cm; padding: 1.2cm; margin: 1cm auto; border: 1px #D3D3D3 solid; background: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; display: flex; flex-direction: column; }
        @page { size: A4; margin: 0; }
        @media print { html, body { width: 21cm; height: 29.7cm; } .page { margin: 0; border: initial; box-shadow: initial; background: initial; } .print-button-container { display: none; } }
        .print-button-container { position: fixed; top: 10px; right: 10px; z-index: 100; }
        .print-button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }

        /* THÔNG TIN CÔNG TY & KHÁCH HÀNG */
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .company-info { width: 60%; line-height: 1.4; font-size: 10pt; }
        .company-info strong { font-size: 11pt; }
        #company_address { font-size: 9pt; }
        .logo { width: 300px; height: auto; }
        .title-section { text-align: center; margin: 20px 0; }
        .title-section h1 { font-size: 18pt; margin: 0; }
        .title-section p { margin: 4px 0; font-size: 11pt; }
        .customer-info { margin-bottom: 15px; line-height: 1.5; }
        .customer-info table { border-collapse: collapse; width: 100%; }
        .customer-info td { padding: 1px 5px; vertical-align: top; }
        .customer-info td:first-child { width: 100px; }
        .intro-line { margin-bottom: 10px; }

        /* BẢNG SẢN PHẨM & TỔNG CỘNG */
        table.products { width: 100%; border-collapse: collapse; font-size: 11pt; }
        table.products thead th, table.products tbody td, table.products tfoot td { border: 1px solid #000; padding: 6px; }
        table.products thead th { background-color: #e0e0e0; font-weight: bold; text-align: center; }
        table.products tbody td:nth-child(1), table.products tbody td:nth-child(3) { text-align: center; }
        table.products tbody td:nth-child(4), table.products tbody td:nth-child(5), table.products tbody td:nth-child(6) { text-align: right; }
        
        table.products tfoot td { border-top: none; font-weight: bold; padding: 6px 8px; }
        .totals-label-cell { text-align: right; }
        .totals-value-cell { text-align: right; }
        .amount-in-words-cell { text-align: right; }
        #grand_total_in_words { font-size: 10pt; font-style: italic; font-weight: bold; }
        
        /* GHI CHÚ, CHỮ KÝ, THANH TOÁN */
        .notes-block { margin-top: 10px; font-size: 10pt; }
        .notes-block p { margin: 0; padding-left: 10px; font-style: italic; }
        .signatures-section { display: flex; justify-content: space-between; margin-top: 20px; text-align: center; }
        .signature-block:first-child { flex-basis: 40%; }
        .signature-block:last-child { flex-basis: 58%; }
        .signature-block .role, .signature-block .instruction { margin: 0; padding: 0; line-height: 1.3; }
        .signature-block .role { font-weight: bold; }
        .signature-block .instruction { font-style: italic; font-size: 10pt; }
        .stamp-container { position: relative; height: 100px; margin-top: 5px; }
        .stamp-container img { max-width: 100%; max-height: 100px; }
        
        .payment-section { margin-top: auto; padding-top: 20px; font-size: 10pt; }
        .payment-section h3 { margin: 0 0 5px 0; font-size: 11pt; }
        .bank-info-container { display: flex; align-items: flex-start; }
        .bank-info-text { flex-grow: 1; }
        .bank-info-text p { margin: 2px 0; }
        #vietqr_code_small { width: 100px; height: 100px; border: 1px solid #ccc; display: block; margin-right: 15px; }

        /* MÀU SẮC DỮ LIỆU ĐỘNG */
        #quote_number, #quote_date, #customer_name, #customer_address, #contact_line, .products tbody td,
        #subtotal, #vat_amount, #grand_total, #grand_total_in_words, #notes_and_terms, #company_name_signature {
            color: #002B5B;
        }
        /* BOLD NỘI DUNG THANH TOÁN */
        #bank_account_name, #bank_account_number, #bank_name, #payment_reference_text {
            font-weight: bold;
            color: #002B5B;
        }
    </style>
</head>
<body>
    <div class="print-button-container"><button class="print-button" onclick="window.print()">In Báo Giá</button></div>
    <div class="page">
        <div class="header">
            <div class="company-info">
                <strong id="company_name"></strong><br>
                <span id="company_address"></span><br>
                <!-- Dòng MST và Zalo mới -->
                MST: <span id="company_tax_code"></span> &nbsp;|&nbsp; Zalo: <a href="#" id="company_zalo_link"></a><br>
                ĐT: <span id="company_phone"></span> &nbsp;|&nbsp; Email: <span id="company_email"></span>
            </div>
            <img src="https://theme.hstatic.net/1000375557/1001056558/14/logo.png?v=439" alt="Logo" class="logo">
        </div>
        <!-- Loại bỏ dòng Dự án -->
        <div class="title-section"><h1>BÁO GIÁ VẬT TƯ</h1><p>Số báo giá: <strong id="quote_number"></strong> &nbsp;|&nbsp; Ngày: <span id="quote_date"></span></p></div>
        <div class="customer-info"><table><tr><td>Kính gởi</td><td>: <strong id="customer_name"></strong></td></tr><tr><td>Địa chỉ</td><td>: <span id="customer_address"></span></td></tr><tr><td>Liên hệ</td><td>: <span id="contact_line"></span></td></tr></table></div>
        <p class="intro-line">Công ty chúng tôi kính gửi đến quý khách bảng báo giá các sản phẩm như sau.</p>
        
        <table class="products">
            <thead><tr><th style="width: 5%;">Stt</th><th style="width: 35%;">Tên sản phẩm</th><th style="width: 8%;">Đvt</th><th style="width: 10%;">Số lượng</th><th style="width: 14%;">Đơn giá<br>(chưa VAT)</th><th style="width: 14%;">Thành tiền<br>(chưa VAT)</th><th style="width: 10%;">Thuế VAT</th></tr></thead>
            <tbody id="product_table_body"></tbody>
            <tfoot>
                <tr><td colspan="5" class="totals-label-cell">Tổng thành Tiền:</td><td class="totals-value-cell" colspan="2"><span id="subtotal"></span></td></tr>
                <tr><td colspan="5" class="totals-label-cell">Thuế VAT:</td><td class="totals-value-cell" colspan="2"><span id="vat_amount"></span></td></tr>
                <tr><td colspan="5" class="totals-label-cell">Tổng tiền đơn hàng:</td><td class="totals-value-cell" colspan="2"><span id="grand_total"></span></td></tr>
                <tr><td colspan="7" class="amount-in-words-cell"><span id="grand_total_in_words"></span></td></tr>
            </tfoot>
        </table>

        <div class="notes-block"><strong>Lưu ý:</strong><p id="notes_and_terms"></p></div>
        
        <div class="signatures-section">
            <div class="signature-block"><p class="role">XÁC NHẬN ĐẶT HÀNG</p><p class="instruction">(ký tên, đóng dấu)</p></div>
            <div class="signature-block"><p class="role" id="company_name_signature"></p><p class="instruction">Giám đốc</p><div class="stamp-container"><img id="company_stamp" src="" alt="Company Stamp"></div></div>
        </div>
        
        <div class="payment-section">
            <h3>Thông tin chuyển khoản:</h3>
            <div class="bank-info-container">
                <img id="vietqr_code_small" src="" alt="VietQR Code">
                <div class="bank-info-text">
                    <p>Tên tk: <span id="bank_account_name"></span></p>
                    <p>Số tk: <span id="bank_account_number"></span>, <span id="bank_name"></span></p>
                    <p>Nội dung: <span id="payment_reference_text"></span></p>
                    <!-- Cập nhật câu hướng dẫn -->
                    <p style="font-style: italic;">(Quý cty ghi đúng Số đơn hàng hoặc số báo giá)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_SIGNATURE_BASE_URL = "https://github.com/truntpv-gif/print/blob/main/";
        const BANK_BINS = { 'techcombank': '970407', 'vietcombank': '970436', 'vpb': '970432', 'vpbank': '970432', 'viettinbank': '970415', 'bidv': '970418', 'agribank': '970405', 'acb': '970416', 'mbbank': '970422', 'mb': '970422', 'sacombank': '970403', 'shb': '970443', 'hdbank': '970437', 'tpbank': '970423', 'vib': '970441', 'seabank': '970440', 'ocb': '970448' };
        
        const BANK_FULL_NAMES = {
            'techcombank': 'Ngân hàng TMCP Kỹ thương Việt Nam (Techcombank)', 'vietcombank': 'Ngân hàng TMCP Ngoại thương Việt Nam (Vietcombank)', 'vpb': 'Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)', 'vpbank': 'Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)', 'viettinbank': 'Ngân hàng TMCP Công Thương Việt Nam (VietinBank)', 'bidv': 'Ngân hàng TMCP Đầu tư và Phát triển Việt Nam (BIDV)', 'agribank': 'Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam (Agribank)', 'acb': 'Ngân hàng TMCP Á Châu (ACB)', 'mbbank': 'Ngân hàng TMCP Quân đội (MB)', 'mb': 'Ngân hàng TMCP Quân đội (MB)', 'sacombank': 'Ngân hàng TMCP Sài Gòn Thương Tín (Sacombank)', 'shb': 'Ngân hàng TMCP Sài Gòn - Hà Nội (SHB)', 'hdbank': 'Ngân hàng TMCP Phát triển Thành phố Hồ Chí Minh (HDBank)', 'tpbank': 'Ngân hàng TMCP Tiên Phong (TPBank)', 'vib': 'Ngân hàng TMCP Quốc Tế Việt Nam (VIB)', 'seabank': 'Ngân hàng TMCP Đông Nam Á (SeABank)', 'ocb': 'Ngân hàng TMCP Phương Đông (OCB)'
        };

        function getQueryParam(param) { return new URLSearchParams(window.location.search).get(param); }

        function docso(number) {
            const defaultNumbers = ' hai ba bốn năm sáu bảy tám chín';
            const chuHangDonVi = ('1 một' + defaultNumbers).split(' ');
            const chuHangChuc = ('lẻ mười' + defaultNumbers).split(' ');
            const chuHangTram = ('không một' + defaultNumbers).split(' ');
            function convert_block_three(number) {
                number = number.replace(/^0+/, ''); if (number == '') return ''; let a = number.split('');
                switch (a.length) {
                    case 0: return ''; case 1: return chuHangDonVi[a[0]]; case 2: return convert_block_two(a[0], a[1]);
                    case 3: let chuc_dv = ''; if (a[1] != 0 || a[2] != 0) { chuc_dv = ' ' + convert_block_two(a[1], a[2]); } let tram = chuHangTram[a[0]] + ' trăm'; return tram + chuc_dv;
                }
            }
            function convert_block_two(b, c) {
                let chuc = chuHangChuc[b]; let donvi = chuHangDonVi[c];
                if (b == 1) { if (c == 0) return chuc; if (c == 5) return chuc + " lăm"; return chuc + " " + donvi; }
                if (b > 1) { if (c == 1) return chuc + " mốt"; if (c == 5) return chuc + " lăm"; if (c == 0) return chuc; return chuc + " " + donvi; }
                if (b == 0) { if (c == 0) return ""; return "lẻ " + donvi; }
            }
            let str = parseInt(number) + ''; if (str == 0) return "Không"; let i = 0, j = str.length; let result = ""; let arr = [];
            while (i < j) { arr.push(str.substring(i, i + 3)); i += 3; }
            let newArr = arr.reverse(); let hang = ["", " nghìn", " triệu", " tỷ", " nghìn tỷ", " triệu tỷ"];
            for (let i = newArr.length - 1; i >= 0; i--) {
                let k = newArr[i];
                if (k != '000') {
                    let blockText = convert_block_three(k);
                    if (result.length > 0) { result += ' '; }
                    result += blockText + hang[i];
                }
            }
            result = result.replace(/ +/g, " ").trim(); return result.charAt(0).toUpperCase() + result.slice(1);
        }

        function generateVietQR(bankName, accountNumber, amount, description, accountName) { const qrImgElement = document.getElementById('vietqr_code_small'); if (!bankName || !accountNumber || !qrImgElement) { if(qrImgElement) qrImgElement.style.display = 'none'; return; } const cleanBankName = (bankName || '').toLowerCase().replace(/\s/g, ''); const bankBin = BANK_BINS[cleanBankName]; if (!bankBin) { console.error('Không tìm thấy mã BIN cho ngân hàng:', bankName); qrImgElement.style.display = 'none'; return; } const cleanAmount = String(amount || '0').replace(/[.,]/g, ''); const addInfo = encodeURIComponent(description || ''); const accName = encodeURIComponent(accountName || ''); const qrUrl = `https://api.vietqr.io/image/${bankBin}-${accountNumber}-G4l0bO1.jpg?amount=${cleanAmount}&addInfo=${addInfo}&accountName=${accName}`; qrImgElement.src = qrUrl; }
        
        function populateData() {
            // ----- BẮT ĐẦU LOGIC MỚI - ĐÃ SỬA LỖI -----
            const dataParam = getQueryParam('data');
            let data = {};

            if (dataParam) {
                try {
                    // TRƯỜNG HỢP 1: Có data hợp lệ từ URL
                    data = JSON.parse(decodeURIComponent(dataParam));
                } catch (e) {
                    // TRƯỜNG HỢP 3: Data lỗi, dùng Demo (không có watermark theo yêu cầu mới)
                    console.error("Lỗi JSON, sử dụng dữ liệu demo:", e);
                    // Có thể thêm dữ liệu demo ở đây nếu muốn
                }
            } else {
                // TRƯỜNG HỢP 2: Không có data, dùng Mặc định
                // Để trống hoặc điền thông tin mặc định nếu cần
            }
            
            const fill = (id, value, isHtml = false) => { const el = document.getElementById(id); if (el) { if (isHtml) el.innerHTML = (value || '').replace(/\\n/g, '<br>'); else el.textContent = value || ''; } };
            const fillAttr = (id, attr, value) => { const el = document.getElementById(id); if (el) el.setAttribute(attr, value || ''); };
            const formatInteger = (num) => { return num ? new Intl.NumberFormat('de-DE').format(Math.round(num)) : ''; };
            const formatDecimal = (num) => { return num ? new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num) : ''; };
            
            fill('company_name', data.company_name);
            fill('company_address', data.company_address, true);
            fill('company_tax_code', data.company_tax_code);
            fill('company_phone', data.company_phone);
            fill('company_email', data.company_email);
            
            // Cập nhật Zalo link
            let zaloLink = data.company_zalo_link || '';
            if (zaloLink && !zaloLink.startsWith('http')) {
                zaloLink = 'https://' + zaloLink;
            }
            fillAttr('company_zalo_link', 'href', zaloLink);
            document.getElementById('company_zalo_link').textContent = (data.company_zalo_link || '').replace(/https?:\/\//, '');

            fill('quote_number', data.quote_number);
            fill('quote_date', data.quote_date);
            fill('customer_name', data.customer_name);
            fill('customer_address', data.customer_address, true);
            const contactParts = []; if (data.customer_contact_person) { contactParts.push(`<strong>${data.customer_contact_person}</strong>`); } if (data.customer_phone) { contactParts.push(`SĐT: ${data.customer_phone}`); } if (data.customer_email) { contactParts.push(`Email: ${data.customer_email}`); } fill('contact_line', contactParts.join(' &nbsp;|&nbsp; '), true);
            
            fill('subtotal', formatInteger(data.subtotal));
            fill('vat_amount', formatInteger(data.vat_amount));
            fill('grand_total', formatInteger(data.grand_total));
            const amountInNumber = String(data.grand_total || '0').replace(/[.,]/g, '');
            const amountInWords = docso(amountInNumber);
            if(data.grand_total > 0){
                fill('grand_total_in_words', `<i><b>(Bằng chữ: ${amountInWords} đồng).</b></i>`, true);
            }
            
            fill('notes_and_terms', data.notes_and_terms, true);
            fill('company_name_signature', data.company_name); 
            const stampImg = document.getElementById('company_stamp'); if (data.company_branch_code && stampImg) { const signatureUrl = GITHUB_SIGNATURE_BASE_URL + data.company_branch_code + ".jpg?raw=true"; stampImg.src = signatureUrl; }
            
            fill('bank_account_name', data.bank_account_name); 
            fill('bank_account_number', data.bank_account_number); 

            const originalShortBankName = data.bank_name || '';
            const shortBankNameKey = originalShortBankName.toLowerCase().replace(/\s/g, '');
            const fullBankName = BANK_FULL_NAMES[shortBankNameKey] || originalShortBankName;
            fill('bank_name', fullBankName);

            let paymentText = data.payment_reference_text || '';
            if (originalShortBankName && fullBankName) {
                const regex = new RegExp(originalShortBankName, 'gi');
                paymentText = paymentText.replace(regex, fullBankName);
            }
            fill('payment_reference_text', paymentText, true); // Dùng isHtml=true để render bold tag nếu có
            
            const tableBody = document.getElementById('product_table_body'); tableBody.innerHTML = '';
            (data.products || []).forEach((item, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = item.ten_sanpham;
                row.insertCell(2).textContent = item.dvt;
                row.insertCell(3).textContent = formatDecimal(item.so_luong);
                row.insertCell(4).textContent = formatInteger(item.don_gia);
                row.insertCell(5).textContent = formatInteger(item.thanh_tien);
                const vatPercent = (item.thue_vat_rate * 100) || 0;
                row.insertCell(6).textContent = `${vatPercent}%`;
            });
            
            generateVietQR(data.bank_name, data.bank_account_number, data.grand_total, `TT BG ${data.quote_number || ''}`, data.bank_account_name);
        }
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
