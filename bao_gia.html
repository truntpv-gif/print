<!DOCTYPE html>
<html>
<head>
    <title>BÁO GIÁ VẬT TƯ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- CẤU HÌNH KHỔ GIẤY A4 (QUAN TRỌNG ĐỂ CÓ LỀ TRANG 2) --- */
        @page {
            size: A4;
            /* Lề vật lý của tờ giấy: Trên/Dưới 1.5cm, Trái/Phải 2.0cm */
            /* Điều này giúp MỌI TRANG đều có lề, không bị sát mép */
            margin: 15mm 20mm; 
        }

        body {
            background-color: #525659;
            margin: 0;
            padding: 0;
            font-family: 'Times New Roman', Times, serif;
            font-size: 11pt;
        }

        /* Giao diện xem trên màn hình */
        .page {
            width: 210mm;
            min-height: 297mm;
            margin: 10mm auto;
            background: white;
            padding: 0; /* Padding đã được @page xử lý khi in */
            /* Padding giả lập khi xem trên web để dễ nhìn */
            padding-left: 20mm; padding-right: 20mm; padding-top: 15mm; padding-bottom: 15mm; 
            
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        /* --- CẤU HÌNH KHI IN --- */
        @media print { 
            body { background: white; margin: 0; }
            .page { 
                width: 100%; margin: 0; 
                padding: 0; /* Bỏ padding vì @page đã có lề */
                border: none; box-shadow: none; 
                min-height: auto; 
                display: block; 
            } 
            .print-button-container { display: none; } 
            
            /* Lặp lại tiêu đề bảng ở đầu mỗi trang */
            thead { display: table-header-group; }
            
            /* Không ngắt dòng giữa chừng */
            tr { page-break-inside: avoid; }
            tr.summary-row { page-break-inside: avoid; page-break-after: auto; }
        }

        .print-button-container { position: fixed; top: 10px; right: 10px; z-index: 100; }
        .print-button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }

        /* --- STYLE NỘI DUNG --- */
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .company-info { width: 65%; color: #000; }
        
        .company-name { font-size: 11pt; font-weight: bold; text-transform: uppercase; margin-bottom: 3px; display: block; line-height: 1.2; }
        .info-line { font-size: 9pt; line-height: 1.2; margin-bottom: 1px; display: block; }
        .contact-group { margin-top: 0; }

        .logo { width: 330px; height: auto; margin-bottom: 5px; }
        
        .quote-details-container { display: flex; flex-direction: column; align-items: flex-end; width: 35%; }
        .quote-info-box { margin-top: 0px; text-align: right; line-height: 1.3; font-size: 11pt; }
        .quote-info-box p { margin: 2px 0; }

        .title-section { text-align: center; margin-top: 30px; margin-bottom: 10px; } 
        .title-section h1 { font-size: 18pt; margin: 0 0 5px 0; font-weight: bold; }
        #customer_project_line { margin: 0; font-size: 11pt; }

        .customer-info { margin-bottom: 5px; line-height: 1.15; font-size: 11pt; }
        .customer-info table { border-collapse: collapse; width: 100%; }
        .customer-info td { padding: 0; vertical-align: top; }
        .customer-info td:first-child { width: 90px; }
        #customer_name { font-size: 12pt; font-weight: bold; text-transform: uppercase; }

        .intro-line { margin-top: 0px; margin-bottom: 10px; }

        table.products { width: 100%; border-collapse: collapse; font-size: 11pt; margin-bottom: 10px; }
        table.products thead th { border: 1px solid #000; padding: 5px; background-color: #e0e0e0; font-weight: bold; text-align: center; }
        table.products tbody td { border: 1px solid #000; padding: 5px; }
        
        table.products tbody td:nth-child(1), table.products tbody td:nth-child(3), table.products tbody td:nth-child(7) { text-align: center; }
        table.products tbody td:nth-child(4), table.products tbody td:nth-child(5), table.products tbody td:nth-child(6) { text-align: right; }

        .total-label { text-align: right; font-weight: bold; border-right: none !important; }
        .total-value { text-align: right; font-weight: bold; border-left: 1px solid #000; }
        .amount-words { text-align: center; font-style: italic; font-weight: bold; padding: 8px 5px !important; }

        .notes-block { margin-top: 0px; font-size: 10pt; }
        .signatures-section { display: flex; justify-content: space-between; text-align: center; margin-top: 20px; page-break-inside: avoid; }
        .stamp-container { height: 135px; margin-top: 5px; display: flex; justify-content: center; }
        #company_stamp { max-height: 135px; width: auto; }

        .bank-info-container { display: flex; align-items: flex-start; margin-top: 15px; font-size: 10pt; page-break-inside: avoid; }
        #vietqr_code_small { width: 90px; height: 90px; border: 1px solid #ccc; margin-right: 15px; }

        #quote_number, #quote_date, #customer_name, #company_name_signature { color: #002B5B; }
        .total-value, .amount-words { color: #002B5B; }
        #bank_account_number, #bank_name { font-weight: bold; color: #002B5B; }
    </style>
</head>
<body>
    <div class="print-button-container"><button class="print-button" onclick="window.print()">In Báo Giá</button></div>
    
    <div class="page">
        <div class="header">
            <div class="company-info">
                <span class="company-name" id="company_name"></span>
                <div id="address_container"></div>
                <div class="contact-group">
                    <div class="info-line">ĐT: <span id="company_phone"></span> &nbsp;|&nbsp; Email: <span id="company_email"></span></div>
                    <div class="info-line">MST: <span id="company_tax_code"></span> &nbsp;|&nbsp; Zalo: <a href="#" id="company_zalo_link"></a></div>
                </div>
            </div>
            <div class="quote-details-container">
                <img src="https://theme.hstatic.net/1000375557/1001056558/14/logo.png?v=439" alt="Logo" class="logo">
                <div class="quote-info-box">
                    <p>Số: <strong id="quote_number"></strong></p>
                    <p>Ngày: <span id="quote_date"></span></p>
                </div>
            </div>
        </div>
        
        <div class="title-section">
            <h1>BÁO GIÁ VẬT TƯ</h1>
            <p id="customer_project_line" style="display: none;"><b><i><span id="customer_project"></span></i></b></p>
        </div>

        <div class="customer-info">
            <table>
                <tr><td>Kính gởi</td><td>: <strong id="customer_name"></strong></td></tr>
                <tr><td>Địa chỉ</td><td>: <span id="customer_address"></span></td></tr>
                <tr><td>Liên hệ</td><td>: <span id="contact_line"></span></td></tr>
            </table>
        </div>
        
        <p class="intro-line">Công ty chúng tôi kính gửi đến quý khách bảng báo giá các sản phẩm như sau.</p>
        
        <table class="products">
            <thead>
                <tr>
                    <th style="width: 5%;">Stt</th><th style="width: 35%;">Tên sản phẩm</th><th style="width: 8%;">Đvt</th><th style="width: 10%;">Số lượng</th>
                    <th style="width: 14%;">Đơn giá<br>(chưa VAT)</th><th style="width: 14%;">Thành tiền<br>(chưa VAT)</th><th style="width: 10%;">Thuế VAT</th>
                </tr>
            </thead>
            <tbody id="product_table_body"></tbody>
        </table>

        <!-- DIV chứa ghi chú -->
        <div class="notes-block" id="notes_and_terms"></div>
        
        <div class="signatures-section">
            <div style="width:40%"><p style="font-weight:bold; margin:0;">XÁC NHẬN ĐẶT HÀNG</p><p style="font-style:italic; margin:0;">(ký tên, đóng dấu)</p></div>
            <div style="width:58%">
                <p style="font-weight:bold; margin:0;" id="company_name_signature"></p>
                <p style="font-style:italic; margin:0;">Giám đốc</p>
                <div class="stamp-container"><img id="company_stamp" src="" alt="Company Stamp"></div>
            </div>
        </div>
        
        <div class="bank-info-container">
            <img id="vietqr_code_small" src="" alt="VietQR">
            <div>
                <h3 style="margin:0 0 5px 0; font-size:11pt;">Thông tin chuyển khoản:</h3>
                <p style="margin:2px 0;">Tên tk: <span id="bank_account_name"></span></p>
                <p style="margin:2px 0;">Số tk: <span id="bank_account_number"></span>, <span id="bank_name"></span></p>
                <p style="margin:2px 0;">Nội dung: <span id="payment_reference_text"></span></p>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_SIGNATURE_BASE_URL = "https://github.com/truntpv-gif/print/blob/main/";
        const BANK_BINS = {'techcombank':'970407','vietcombank':'970436','vpb':'970432','vpbank':'970432','viettinbank':'970415','bidv':'970418','agribank':'970405','acb':'970416','mbbank':'970422','mb':'970422','sacombank':'970403','shb':'970443','hdbank':'970437','tpbank':'970423','vib':'970441','seabank':'970440','ocb':'970448'};
        const BANK_FULL_NAMES = {'techcombank':'Ngân hàng TMCP Kỹ thương Việt Nam (Techcombank)','vietcombank':'Ngân hàng TMCP Ngoại thương Việt Nam (Vietcombank)','vpb':'Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)','vpbank':'Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)','viettinbank':'Ngân hàng TMCP Công Thương Việt Nam (VietinBank)','bidv':'Ngân hàng TMCP Đầu tư và Phát triển Việt Nam (BIDV)','agribank':'Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam (Agribank)','acb':'Ngân hàng TMCP Á Châu (ACB)','mbbank':'Ngân hàng TMCP Quân đội (MB)','mb':'Ngân hàng TMCP Quân đội (MB)','sacombank':'Ngân hàng TMCP Sài Gòn Thương Tín (Sacombank)','shb':'Ngân hàng TMCP Sài Gòn - Hà Nội (SHB)','hdbank':'Ngân hàng TMCP Phát triển Thành phố Hồ Chí Minh (HDBank)','tpbank':'Ngân hàng TMCP Tiên Phong (TPBank)','vib':'Ngân hàng TMCP Quốc Tế Việt Nam (VIB)','seabank':'Ngân hàng TMCP Đông Nam Á (SeABank)','ocb':'Ngân hàng TMCP Phương Đông (OCB)'};

        function getDataString() {
            if (window.location.hash) {
                let h = window.location.hash.substring(1); 
                if(h.startsWith('data=')) return h.substring(5);
                return h;
            }
            return new URLSearchParams(window.location.search).get('data');
        }

        function cleanJson(str) {
            if (!str) return "{}";
            return str.replace(/,(\s*])/g, "$1").replace(/,(\s*})/g, "$1").replace(/,,\s*/g, ",");
        }

        function docso(sotien) {
            const chuSo = ["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"]; const hang = ["","nghìn","triệu","tỷ","nghìn tỷ","triệu tỷ"];
            function docNhom(nhom, first) {
                let t = Math.floor(nhom/100), c = Math.floor((nhom%100)/10), d = nhom%10, kq = [];
                if (t > 0) kq.push(chuSo[t], "trăm");
                if (c > 1) { kq.push(chuSo[c], "mươi"); if (d==1) kq.push("mốt"); else if (d>1) kq.push(chuSo[d]); }
                else if (c == 1) { kq.push("mười"); if (d==5) kq.push("lăm"); else if (d>0) kq.push(chuSo[d]); }
                else if (d > 0) { if (!first || t > 0) kq.push("linh"); kq.push(chuSo[d]); }
                return kq;
            }
            if (!sotien || isNaN(sotien) || Number(sotien)===0) return "";
            let s = String(Math.floor(Math.abs(Number(sotien)))), g = [], res = [];
            while (s.length > 0) { g.push(s.slice(Math.max(s.length-3, 0))); s = s.slice(0, Math.max(s.length-3, 0)); }
            for (let i = g.length-1; i >= 0; i--) { 
                let n = parseInt(g[i]); if(n===0) continue;
                let r = docNhom(n, res.length===0); if(r.length>0) res.push(...r, hang[i]); 
            }
            let str = res.join(" ").trim(); 
            if(str.endsWith(hang[0])) str = str.slice(0, str.length - hang[0].length).trim();
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function generateVietQR(bN, acN, am, desc, acName) { 
            const img = document.getElementById('vietqr_code_small'); if(!bN || !acN) { if(img) img.style.display='none'; return; }
            const bin = BANK_BINS[(bN||'').toLowerCase().replace(/\s/g, '')]; if(!bin) { if(img) img.style.display='none'; return; }
            img.src = `https://api.vietqr.io/image/${bin}-${acN}-G4l0bO1.jpg?amount=${String(am||0).replace(/\D/g,'')}&addInfo=${encodeURIComponent(desc||'')}&accountName=${encodeURIComponent(acName||'')}`;
        }

        function expandData(short) {
            const map = {
                'c_n':'company_name', 'c_t':'company_tax_code', 'c_a':'company_address', 'c_p':'company_phone', 'c_z':'company_zalo_link', 'c_e':'company_email', 'c_b':'company_branch_code',
                'qn':'quote_number', 'qd':'quote_date', 'cn':'customer_name', 'ca':'customer_address', 'cp':'customer_phone', 'ce':'customer_email', 'cc':'customer_contact_person', 'pj':'customer_project',
                'st':'subtotal', 'va':'vat_amount', 'gt':'grand_total', 'nt':'notes_and_terms', 'pr':'products',
                'b_an':'bank_account_name', 'b_n':'bank_account_number', 'b_nm':'bank_name', 'ref':'payment_reference_text'
            };
            const rec = (obj) => {
                if (Array.isArray(obj)) return obj.map(rec);
                if (typeof obj === 'object' && obj !== null) return Object.keys(obj).reduce((a, k) => { a[map[k]||k] = rec(obj[k]); return a; }, {});
                return obj;
            };
            return rec(short);
        }

        function populateData() {
            const hash = getDataString();
            if (!hash) { alert("Không tìm thấy dữ liệu báo giá!"); return; }

            let raw = {};
            try {
                const decoded = decodeURIComponent(hash).replace(/(?<!\\)\n/g, '\\n');
                const clean = cleanJson(decoded); 
                raw = JSON.parse(clean);
            } catch (e) {
                console.error(e);
                alert("Lỗi dữ liệu JSON");
                return;
            }

            const data = expandData(raw);
            const fill = (id, v) => { const el = document.getElementById(id); if(el) el.innerHTML = (v||'').replace(/\\n/g, '<br>'); };
            const fmt = (n) => new Intl.NumberFormat('de-DE').format(Math.round(n||0));
            const dec = (n) => new Intl.NumberFormat('de-DE', {minimumFractionDigits:2}).format(n||0);

            let addr = data.company_address || "";
            let addrLines = addr.split(/;|\\n/);
            let addrHtml = "";
            addrLines.forEach(line => {
                if(line.trim() !== "") {
                    addrHtml += `<div class="info-line">${line.trim()}</div>`;
                }
            });
            document.getElementById('address_container').innerHTML = addrHtml;

            fill('company_name', data.company_name); 
            fill('company_phone', data.company_phone); fill('company_email', data.company_email);
            fill('company_tax_code', data.company_tax_code); 
            const zl = (data.company_zalo_link||'').replace(/https?:\/\//,'');
            const zlEl = document.getElementById('company_zalo_link'); if(zlEl) { zlEl.href = data.company_zalo_link; zlEl.textContent = zl; }

            fill('quote_number', data.quote_number); fill('quote_date', data.quote_date);
            fill('customer_name', data.customer_name); fill('customer_address', data.customer_address);
            fill('contact_line', [data.customer_contact_person, data.customer_phone, data.customer_email].filter(Boolean).join(' | '));
            
            const pjEl = document.getElementById('customer_project_line');
            if(data.customer_project) { fill('customer_project', "Dự án: "+data.customer_project); pjEl.style.display='block'; } else pjEl.style.display='none';

            const tbody = document.getElementById('product_table_body'); tbody.innerHTML = '';
            let items = data.products || [], norm = [], ship = [];
            
            items.forEach(it => {
                let obj = Array.isArray(it) ? {ten_sanpham:it[0], dvt:it[1], so_luong:it[2], don_gia:it[3], thanh_tien:it[4], thue_vat_rate:it[5]} : it;
                let n = (obj.ten_sanpham||'').toLowerCase();
                if(n.includes('vận chuyển')||n.includes('giao hàng')||n.includes('ship')) ship.push(obj); else norm.push(obj);
            });
            
            [...norm, ...ship].forEach((it, i) => {
                let row = tbody.insertRow();
                row.innerHTML = `<td>${i+1}</td><td>${it.ten_sanpham}</td><td>${it.dvt}</td>
                <td>${dec(it.so_luong)}</td><td>${fmt(it.don_gia)}</td><td>${fmt(it.thanh_tien)}</td><td>${(it.thue_vat_rate||0)*100}%</td>`;
            });

            const strAmt = String(data.grand_total||0).replace(/\D/g,'');
            const amtInWords = Number(strAmt)>0 ? `(Bằng chữ: ${docso(strAmt)} đồng).` : '';
            
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="summary-row"><td colspan="5" class="total-label">Tổng thành Tiền:</td><td colspan="2" class="total-value">${fmt(data.subtotal)}</td></tr>
                <tr class="summary-row"><td colspan="5" class="total-label">Thuế VAT:</td><td colspan="2" class="total-value">${fmt(data.vat_amount)}</td></tr>
                <tr class="summary-row"><td colspan="5" class="total-label">Tổng tiền đơn hàng:</td><td colspan="2" class="total-value">${fmt(data.grand_total)}</td></tr>
                <tr class="summary-row"><td colspan="7" class="amount-words">${amtInWords}</td></tr>
            `);
            
            // --- XỬ LÝ LƯU Ý (TỰ THÊM CHỮ "LƯU Ý:" IN ĐẬM VÀ CANH LỀ) ---
             if (data.notes_and_terms) {
                let notesArr = data.notes_and_terms.split(/\|\|BR\|\||\\n|\n/);
                
                // Dùng Flexbox chia làm 2 phần: [Tiêu đề] và [Nội dung]
                // Phần tiêu đề "Lưu ý:" nằm bên trái
                // Phần nội dung nằm bên phải, tự động thẳng hàng với nhau
                let notesHtml = '<div style="display: flex; align-items: baseline;">';
                
                // Cột trái: Chữ "Lưu ý:" cố định
                notesHtml += '<div style="font-weight: bold; white-space: nowrap; margin-right: 5px;">Lưu ý:</div>';
                
                // Cột phải: Danh sách các dòng ghi chú
                notesHtml += '<div>';
                notesArr.forEach((note, index) => {
                    if(note.trim() !== "") {
                        // Dòng thứ 2 trở đi cách dòng trên 2px cho thoáng
                        let style = index > 0 ? 'style="margin-top: 2px;"' : '';
                        notesHtml += `<div ${style}>${note.trim()}</div>`;
                    }
                });
                notesHtml += '</div></div>'; // Đóng thẻ
                
                document.getElementById('notes_and_terms').innerHTML = notesHtml;
            } else {
                document.getElementById('notes_and_terms').innerHTML = "";
            }
            // ------------------------------------------------
            fill('company_name_signature', data.company_name);
            const stp = document.getElementById('company_stamp'); if(data.company_branch_code && stp) stp.src = GITHUB_SIGNATURE_BASE_URL + data.company_branch_code + ".jpg?raw=true";

            fill('bank_account_name', data.bank_account_name); fill('bank_account_number', data.bank_account_number);
            const bnKey = (data.bank_name||'').toLowerCase().replace(/\s/g,'');
            fill('bank_name', BANK_FULL_NAMES[bnKey] || data.bank_name);
            fill('payment_reference_text', data.payment_reference_text);
            generateVietQR(data.bank_name, data.bank_account_number, data.grand_total, `TT BG ${data.quote_number||''}`, data.bank_account_name);
        }
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
