<!DOCTYPE html>
<html>
<head>
    <title>BÁO GIÁ VẬT TƯ (CHẾ ĐỘ SỬA LỖI)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS CƠ BẢN ĐỂ HIỂN THỊ LỖI RÕ RÀNG */
        body { font-family: monospace; padding: 20px; line-height: 1.4; }
        .error-box { background: #ffe6e6; border: 1px solid red; padding: 15px; color: #cc0000; margin-bottom: 20px; }
        .raw-data-box { background: #f0f0f0; border: 1px solid #999; padding: 10px; word-wrap: break-word; white-space: pre-wrap; }
        
        /* CSS CŨ ĐỂ NẾU CHẠY ĐÚNG THÌ VẪN HIỆN ĐẸP */
        .page { width: 21cm; min-height: 29.7cm; padding: 1.2cm; margin: 1cm auto; border: 1px #D3D3D3 solid; background: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; display: flex; flex-direction: column; }
        @page { size: A4; margin: 10mm; }
        @media print { html, body { width: 21cm; } .page { margin: 0; border: initial; box-shadow: initial; background: initial; } .print-button-container { display: none; } .debug-info { display: none; } }
        .print-button-container { position: fixed; top: 10px; right: 10px; z-index: 100; }
        .print-button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .company-info { width: 60%; line-height: 1.4; font-size: 10pt; font-family: 'Times New Roman'; }
        .quote-details-container { display: flex; flex-direction: column; align-items: flex-end; }
        .title-section { text-align: center; margin: 20px 0; font-family: 'Times New Roman'; }
        table.products { width: 100%; border-collapse: collapse; font-size: 11pt; font-family: 'Times New Roman'; }
        table.products thead th, table.products tbody td, table.products tfoot td { border: 1px solid #000; padding: 6px; }
        /* MÀU SẮC */
        #quote_number, #grand_total { color: #002B5B; }
    </style>
</head>
<body>
    <!-- PHẦN HIỂN THỊ NẾU CÓ LỖI -->
    <div id="debug_display" style="display:none;"></div>

    <!-- PHẦN HIỂN THỊ BÁO GIÁ (Mặc định ẩn, chỉ hiện khi load thành công) -->
    <div id="main_content" style="display:none;">
        <div class="print-button-container"><button class="print-button" onclick="window.print()">In Báo Giá</button></div>
        <div class="page">
            <div class="header">
                <div class="company-info">
                    <strong id="company_name"></strong><br>
                    <span id="company_address"></span><br>
                    ĐT: <span id="company_phone"></span> | MST: <span id="company_tax_code"></span>
                </div>
                <div class="quote-details-container">
                    <img src="https://theme.hstatic.net/1000375557/1001056558/14/logo.png?v=439" alt="Logo" style="width: 200px;">
                    <div style="text-align: right;">Số: <strong id="quote_number"></strong><br>Ngày: <span id="quote_date"></span></div>
                </div>
            </div>
            
            <div class="title-section">
                <h1>BÁO GIÁ VẬT TƯ</h1>
                <p id="customer_project_line"><b><i><span id="customer_project"></span></i></b></p>
            </div>

            <div style="font-family: 'Times New Roman'; margin-bottom: 10px;">
                Kính gửi: <strong id="customer_name"></strong><br>
                Địa chỉ: <span id="customer_address"></span><br>
                Liên hệ: <span id="contact_line"></span>
            </div>
            
            <table class="products">
                <thead><tr><th>Stt</th><th>Tên sản phẩm</th><th>Đvt</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th><th>VAT</th></tr></thead>
                <tbody id="product_table_body"></tbody>
                <tfoot>
                    <tr><td colspan="5" style="text-align:right;">Tổng cộng:</td><td colspan="2" style="text-align:right;"><span id="grand_total"></span></td></tr>
                    <tr><td colspan="7" style="text-align:right;"><span id="grand_total_in_words" style="font-style:italic; font-weight:bold;"></span></td></tr>
                </tfoot>
            </table>
            
            <div style="margin-top:20px; font-family: 'Times New Roman';">
                <strong>Ghi chú:</strong> <span id="notes_and_terms"></span>
            </div>

             <div style="margin-top: 30px; display: flex; justify-content: space-between; text-align: center; font-family: 'Times New Roman'; page-break-inside: avoid;">
                <div><strong>XÁC NHẬN ĐẶT HÀNG</strong><br><i>(ký tên, đóng dấu)</i></div>
                <div><strong id="company_name_signature"></strong><br><i>Giám đốc</i><br><div style="height:100px; margin-top:5px;"><img id="company_stamp" src="" style="max-height:100px;"></div></div>
            </div>

            <div style="margin-top: 20px; font-family: 'Times New Roman'; page-break-inside: avoid;">
                <h3>Thông tin chuyển khoản:</h3>
                <div style="display:flex;">
                    <img id="vietqr_code_small" src="" style="width:100px; height:100px; margin-right:15px; border:1px solid #ccc;">
                    <div>
                        TK: <b id="bank_account_number"></b> - <b id="bank_name"></b><br>
                        Chủ TK: <b id="bank_account_name"></b><br>
                        Nội dung: <b id="payment_reference_text"></b>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === HÀM HỖ TRỢ ===
        const GITHUB_SIGNATURE_BASE_URL = "https://github.com/truntpv-gif/print/blob/main/";
        const BANK_BINS = { 'techcombank': '970407', 'vietcombank': '970436', 'vpb': '970432', 'vpbank': '970432', 'viettinbank': '970415', 'bidv': '970418', 'agribank': '970405', 'acb': '970416', 'mbbank': '970422', 'mb': '970422', 'sacombank': '970403', 'shb': '970443', 'hdbank': '970437', 'tpbank': '970423', 'vib': '970441', 'seabank': '970440', 'ocb': '970448' };
        
        function getDataString() {
            if (window.location.hash) {
                let h = window.location.hash.substring(1); 
                if(h.startsWith('data=')) return h.substring(5);
                return h;
            }
            return new URLSearchParams(window.location.search).get('data');
        }

        // --- CỰC KỲ QUAN TRỌNG: HÀM SỬA LỖI JSON MẠNH MẼ HƠN ---
        function cleanJson(str) {
            if (!str) return "{}";
            // 1. Xóa dấu phẩy trước dấu đóng ngoặc vuông ] (Lỗi phổ biến nhất của AppSheet)
            let cleaned = str.replace(/,(\s*])/g, "$1");
            // 2. Xóa dấu phẩy trước dấu đóng ngoặc nhọn }
            cleaned = cleaned.replace(/,(\s*})/g, "$1");
            return cleaned;
        }
        
        function docso(sotien) { /* (Giữ nguyên hàm đọc số của bạn để code gọn) */ if(!sotien) return ""; return "Số tiền bằng chữ..."; } 
        function generateVietQR(bankName, accountNumber, amount, description, accountName) { const qrImgElement = document.getElementById('vietqr_code_small'); if (!bankName || !accountNumber || !qrImgElement) { if(qrImgElement) qrImgElement.style.display = 'none'; return; } const cleanBankName = (bankName || '').toLowerCase().replace(/\s/g, ''); const bankBin = BANK_BINS[cleanBankName]; if (!bankBin) { qrImgElement.style.display = 'none'; return; } const cleanAmount = String(amount || '0').replace(/[.,]/g, ''); const addInfo = encodeURIComponent(description || ''); const accName = encodeURIComponent(accountName || ''); const qrUrl = `https://api.vietqr.io/image/${bankBin}-${accountNumber}-G4l0bO1.jpg?amount=${cleanAmount}&addInfo=${addInfo}&accountName=${accName}`; qrImgElement.src = qrUrl; }

        function expandData(shortData) {
            const map = {
                'c_n': 'company_name', 'c_t': 'company_tax_code', 'c_a': 'company_address', 'c_p': 'company_phone', 'c_z': 'company_zalo_link', 'c_e': 'company_email', 'c_b': 'company_branch_code',
                'qn': 'quote_number', 'qd': 'quote_date',
                'cn': 'customer_name', 'ca': 'customer_address', 'cp': 'customer_phone', 'ce': 'customer_email', 'cc': 'customer_contact_person', 'pj': 'customer_project',
                'st': 'subtotal', 'va': 'vat_amount', 'gt': 'grand_total', 'nt': 'notes_and_terms',
                'pr': 'products',
                'b_an': 'bank_account_name', 'b_n': 'bank_account_number', 'b_nm': 'bank_name', 'ref': 'payment_reference_text'
            };
            const renameKeys = (obj) => {
                if (Array.isArray(obj)) return obj.map(renameKeys);
                if (typeof obj === 'object' && obj !== null) {
                    return Object.keys(obj).reduce((acc, key) => { const newKey = map[key] || key; acc[newKey] = renameKeys(obj[key]); return acc; }, {});
                } return obj;
            };
            return renameKeys(shortData);
        }

        // === HÀM CHÍNH ===
        function populateData() {
            const dataParam = getDataString();
            
            // Debug: Nếu không có dữ liệu
            if (!dataParam) {
                document.getElementById('debug_display').style.display = 'block';
                document.getElementById('debug_display').innerHTML = '<div class="error-box"><h1>KHÔNG TÌM THẤY DỮ LIỆU</h1><p>Không thấy tham số #data= trên thanh địa chỉ.</p></div>';
                return;
            }

            let finalJsonString = "";
            let rawData = {};

            try {
                const decodedParam = decodeURIComponent(dataParam);
                // Xử lý xuống dòng và xóa dấu phẩy thừa
                const sanitizedJsonString = decodedParam.replace(/(?<!\\)\n/g, '\\n');
                finalJsonString = cleanJson(sanitizedJsonString);
                
                rawData = JSON.parse(finalJsonString);
                
                // --- NẾU PARSE THÀNH CÔNG: CHẠY CODE HIỂN THỊ BÌNH THƯỜNG ---
                document.getElementById('main_content').style.display = 'block';
                
                let data = expandData(rawData);
                const fill = (id, val) => { const el = document.getElementById(id); if(el) el.innerHTML = (val||'').replace(/\\n/g, '<br>'); };
                const fmt = (num) => new Intl.NumberFormat('de-DE').format(Math.round(num || 0));

                fill('company_name', data.company_name);
                fill('company_address', data.company_address);
                fill('company_phone', data.company_phone);
                fill('company_tax_code', data.company_tax_code);
                fill('quote_number', data.quote_number);
                fill('quote_date', data.quote_date);
                fill('customer_name', data.customer_name);
                fill('customer_address', data.customer_address);
                fill('contact_line', [data.customer_contact_person, data.customer_phone, data.customer_email].filter(Boolean).join(' - '));
                
                const pjLine = document.getElementById('customer_project_line');
                if(data.customer_project) { fill('customer_project', "Dự án: " + data.customer_project); pjLine.style.display='block'; } else { pjLine.style.display='none'; }

                // Bảng sản phẩm
                const tableBody = document.getElementById('product_table_body'); tableBody.innerHTML = '';
                let productsList = data.products || [];
                let normalItems = [], shippingItems = [];
                
                // Chuẩn hóa item (Mảng -> Object)
                const normalizeItem = (it) => {
                    if (Array.isArray(it)) return { ten_sanpham: it[0], dvt: it[1], so_luong: it[2], don_gia: it[3], thanh_tien: it[4], thue_vat_rate: it[5] };
                    return it; 
                };

                productsList.forEach(rawItem => {
                    let item = normalizeItem(rawItem);
                    let name = (item.ten_sanpham || '').toLowerCase();
                    if (name.includes('vận chuyển') || name.includes('giao hàng') || name.includes('ship')) { shippingItems.push(item); } else { normalItems.push(item); }
                });

                [...normalItems, ...shippingItems].forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td style="text-align:center">${index+1}</td>
                        <td>${item.ten_sanpham}</td>
                        <td style="text-align:center">${item.dvt}</td>
                        <td style="text-align:right">${new Intl.NumberFormat('de-DE', {minimumFractionDigits:2}).format(item.so_luong)}</td>
                        <td style="text-align:right">${fmt(item.don_gia)}</td>
                        <td style="text-align:right">${fmt(item.thanh_tien)}</td>
                        <td style="text-align:center">${(item.thue_vat_rate||0)*100}%</td>`;
                });

                fill('grand_total', fmt(data.grand_total));
                // (Thêm hàm đọc số ở đây nếu cần, tạm thời để trống cho gọn debug)
                
                fill('notes_and_terms', data.notes_and_terms);
                fill('company_name_signature', data.company_name);
                const stampImg = document.getElementById('company_stamp'); if (data.company_branch_code && stampImg) { stampImg.src = GITHUB_SIGNATURE_BASE_URL + data.company_branch_code + ".jpg?raw=true"; }

                fill('bank_account_number', data.bank_account_number);
                fill('bank_name', data.bank_name);
                fill('bank_account_name', data.bank_account_name);
                fill('payment_reference_text', data.payment_reference_text);
                generateVietQR(data.bank_name, data.bank_account_number, data.grand_total, `TT BG ${data.quote_number}`, data.bank_account_name);

            } catch (e) {
                // --- BẮT LỖI VÀ HIỂN THỊ RA MÀN HÌNH ---
                document.getElementById('debug_display').style.display = 'block';
                document.getElementById('debug_display').innerHTML = `
                    <div class="error-box">
                        <h2>⚠️ CÓ LỖI XẢY RA (JSON PARSE ERROR)</h2>
                        <p><strong>Lỗi chi tiết:</strong> ${e.message}</p>
                        <p>Dưới đây là dữ liệu mà AppSheet gửi sang. Hãy chụp hình phần này gửi cho mình:</p>
                    </div>
                    <div class="raw-data-box">${finalJsonString.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                `;
            }
        }
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
