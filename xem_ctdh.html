<!DOCTYPE html>
<html>
<head>
    <title>THÔNG TIN XUẤT HÓA ĐƠN</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS CHUNG & BỐ CỤC */
        body { background-color: #fff; margin: 0; padding: 0; font-family: 'Times New Roman', Times, serif; font-size: 11pt; }
        .page { width: 21cm; min-height: 29.7cm; padding: 1.2cm; margin: 1cm auto; border: 1px #D3D3D3 solid; background: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; display: flex; flex-direction: column; }
        
        @page { 
            size: A4; 
            margin: 10mm; 
        }
        
        @media print { 
            html, body { 
                width: 21cm; 
            } 
            .page { 
                margin: 0; 
                border: initial; 
                box-shadow: initial; 
                background: initial; 
            } 
            .print-button-container { display: none; } 
        }
        .print-button-container { position: fixed; top: 10px; right: 10px; z-index: 100; }
        .print-button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }

        /* THÔNG TIN CÔNG TY & KHÁCH HÀNG */
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .company-info { width: 60%; line-height: 1.4; font-size: 10pt; }
        .company-info strong { font-size: 11pt; }
        #company_address { font-size: 9pt; }
        .logo { width: 300px; height: auto; }
        
        .quote-details-container { display: flex; flex-direction: column; align-items: flex-end; }
        .quote-info-box { margin-top: 8px; text-align: right; line-height: 1.5; font-size: 11pt; }
        .quote-info-box p { margin: 0; }

        .title-section { text-align: center; margin: 20px 0; }
        .title-section h1 { font-size: 18pt; margin: 0; }
        .title-section p { margin: 5px 0; font-size: 11pt; }
        .customer-info { margin-bottom: 10; line-height: 1.5; }
        .customer-info table { border-collapse: collapse; width: 100%; }
        .customer-info td { padding: 1px 5px; vertical-align: top; }
        .customer-info td:first-child { width: 100px; }
        .intro-line { margin-top: 0; margin-bottom: 10px; }

        /* BẢNG SẢN PHẨM & TỔNG CỘNG */
        table.products { width: 100%; border-collapse: collapse; font-size: 11pt; }
        table.products thead th, table.products tbody td, table.products tfoot td { border: 1px solid #000; padding: 6px; }
        table.products thead th { background-color: #e0e0e0; font-weight: bold; text-align: center; }
        table.products tbody td:nth-child(1), table.products tbody td:nth-child(3) { text-align: center; }
        table.products tbody td:nth-child(4), table.products tbody td:nth-child(5), table.products tbody td:nth-child(6) { text-align: right; }
        
        table.products tfoot td { border-top: none; font-weight: bold; padding: 6px 8px; }
        .totals-label-cell { text-align: right; }
        .totals-value-cell { text-align: right; }
        .amount-in-words-cell { text-align: right; }
        #grand_total_in_words { font-size: 10pt; font-style: italic; font-weight: bold; }
        
        /* GHI CHÚ, CHỮ KÝ, THANH TOÁN */
        .notes-block { margin-top: 10px; font-size: 10pt; }
        .notes-block p { margin: 0; padding-left: 10px; font-style: italic; }

        /* === THAY ĐỔI CHÍNH Ở ĐÂY === */
        .final-section-group {
            page-break-inside: avoid;
            /* Thay đổi: Bỏ margin-top: auto và padding-top để khối này nằm ngay sau Ghi chú */
            margin-top: 30px; 
            /* margin-top: auto; đã bị xóa */
            /* padding-top: 20px; đã bị xóa */
        }

        .signatures-section { display: flex; justify-content: space-between; text-align: center; }
        .signature-block:first-child { flex-basis: 40%; }
        .signature-block:last-child { flex-basis: 58%; }
        .signature-block .role, .signature-block .instruction { margin: 0; padding: 0; line-height: 1.3; }
        .signature-block .role { font-weight: bold; }
        .signature-block .instruction { font-style: italic; font-size: 10pt; }
        .stamp-container { position: relative; height: 100px; margin-top: 5px; }
        .stamp-container img { max-width: 100%; max-height: 100px; }
        
        .payment-section { margin-top: 20px; font-size: 10pt; } 
        .payment-section h3 { margin: 0 0 5px 0; font-size: 11pt; }
        .bank-info-container { display: flex; align-items: flex-start; }
        .bank-info-text { flex-grow: 1; }
        .bank-info-text p { margin: 2px 0; }
        #vietqr_code_small { width: 100px; height: 100px; border: 1px solid #ccc; display: block; margin-right: 15px; }

        /* MÀU SẮC DỮ LIỆU ĐỘNG */
        #so_dh, #ngay_lap, #ten_kh, #code, #contact_line, .products tbody td,
        #subtotal, #vat_amount, #grand_total, #grand_total_in_words, #notes_and_terms, #company_name_signature, #company_tax_code, #ten_du_an {
            color: #002B5B;
        }
        #bank_account_name, #bank_account_number, #bank_name, #payment_reference_text {
            font-weight: bold;
            color: #002B5B;
        }
    </style>
</head>
<body>
    <div class="print-button-container"><button class="print-button" onclick="window.print()">In Báo Giá</button></div>
    <div class="page">
        <div class="header">
            <div class="company-info">
                <strong id="company_name"></strong><br>
                <span id="company_address"></span><br>
                ĐT: <span id="company_phone"></span> &nbsp;|&nbsp; Email: <span id="company_email"></span><br>
                MST: <span id="company_tax_code"></span> &nbsp;|&nbsp; Zalo: <a href="#" id="company_zalo_link"></a>
            </div>
            <div class="quote-details-container">
                <img src="https://theme.hstatic.net/1000375557/1001056558/14/logo.png?v=439" alt="Logo" class="logo">
                <div class="quote-info-box">
                    <p>Số: <strong id="so_dh"></strong></p>
                    <p>Ngày: <span id="ngay_lap"></span></p>
                </div>
            </div>
        </div>
        
        <div class="title-section">
            <h1>THÔNG TIN XUẤT HÓA ĐƠN</h1>
            <p id="ten_du_an_line" style="display: none;">
                <b><i><span id="ten_du_an"></span></i></b>
            </p>
        </div>

        <div class="customer-info"><table><tr><td>Khách hàng</td><td>: <strong id="ten_kh"></strong></td></tr><tr><td>
            Email nhận HĐ</td><td>: <span id="tax_code"></span></td></tr><tr><td>
            MST</td><td>: <span id="tax_code_1"></span></td></tr><tr><td>
            TEST thử</td><td>: <span id="tax_email"></span></td></tr><tr><td>
            Dự án </td><td>: <span id="ten_du_an"></span></td></tr></table></div>
        <p class="intro-line">Công ty chúng tôi kính gửi đến quý khách bảng báo giá các sản phẩm như sau.</p>
        
        <table class="products">
            <thead><tr><th style="width: 5%;">Stt</th><th style="width: 35%;">Tên sản phẩm</th><th style="width: 8%;">Đvt</th><th style="width: 10%;">Số lượng</th><th style="width: 14%;">Đơn giá<br>(chưa VAT)</th><th style="width: 14%;">Thành tiền<br>(chưa VAT)</th><th style="width: 10%;">Thuế VAT</th></th></thead>
            <tbody id="product_table_body"></tbody>
            <tfoot>
                <tr><td colspan="5" class="totals-label-cell">Tổng thành Tiền:</td><td class="totals-value-cell" colspan="2"><span id="subtotal"></span></td></tr>
                <tr><td colspan="5" class="totals-label-cell">Thuế VAT:</td><td class="totals-value-cell" colspan="2"><span id="vat_amount"></span></td></tr>
                <tr><td colspan="5" class="totals-label-cell">Tổng tiền đơn hàng:</td><td class="totals-value-cell" colspan="2"><span id="grand_total"></span></td></tr>
                <tr><td colspan="7" class="amount-in-words-cell"><span id="grand_total_in_words"></span></td></tr>
            </tfoot>
        </table>

        <div class="notes-block"><strong></strong><p id="notes_and_terms"></p></div>
        
        <div class="final-section-group">
                        
            <div class="payment-section">
                                
            </div>
        </div>
    </div>

    <script>
        // ... (Phần Javascript không thay đổi) ...
        const GITHUB_SIGNATURE_BASE_URL = "https://github.com/truntpv-gif/print/blob/main/";
        const BANK_BINS = { 'techcombank': '970407', 'vietcombank': '970436', 'vpb': '970432', 'vpbank': '970432', 'viettinbank': '970415', 'bidv': '970418', 'agribank': '970405', 'acb': '970416', 'mbbank': '970422', 'mb': '970422', 'sacombank': '970403', 'shb': '970443', 'hdbank': '970437', 'tpbank': '970423', 'vib': '970441', 'seabank': '970440', 'ocb': '970448' };
        
        const BANK_FULL_NAMES = { 'techcombank': 'Ngân hàng TMCP Kỹ thương Việt Nam (Techcombank)', 'vietcombank': 'Ngân hàng TMCP Ngoại thương Việt Nam (Vietcombank)', 'vpb': 'Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)', 'vpbank': 'Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)', 'viettinbank': 'Ngân hàng TMCP Công Thương Việt Nam (VietinBank)', 'bidv': 'Ngân hàng TMCP Đầu tư và Phát triển Việt Nam (BIDV)', 'agribank': 'Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam (Agribank)', 'acb': 'Ngân hàng TMCP Á Châu (ACB)', 'mbbank': 'Ngân hàng TMCP Quân đội (MB)', 'mb': 'Ngân hàng TMCP Quân đội (MB)', 'sacombank': 'Ngân hàng TMCP Sài Gòn Thương Tín (Sacombank)', 'shb': 'Ngân hàng TMCP Sài Gòn - Hà Nội (SHB)', 'hdbank': 'Ngân hàng TMCP Phát triển Thành phố Hồ Chí Minh (HDBank)', 'tpbank': 'Ngân hàng TMCP Tiên Phong (TPBank)', 'vib': 'Ngân hàng TMCP Quốc Tế Việt Nam (VIB)', 'seabank': 'Ngân hàng TMCP Đông Nam Á (SeABank)', 'ocb': 'Ngân hàng TMCP Phương Đông (OCB)' };

        function getQueryParam(param) { return new URLSearchParams(window.location.search).get(param); }

        function docso(sotien) {
            const chuSo = ["không", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
            const hang = ["", "nghìn", "triệu", "tỷ", "nghìn tỷ", "triệu tỷ"];

            // Sửa đổi hàm con: Thêm tham số 'isFirstGroup' để xử lý logic đặc biệt
            function docNhomBaChuSo(nhom, isFirstGroup = false) {
                let tram = Math.floor(nhom / 100);
                let chuc = Math.floor((nhom % 100) / 10);
                let donvi = nhom % 10;
                let ketqua = [];

                if (tram > 0) {
                    ketqua.push(chuSo[tram], "trăm");
                }

                if (chuc > 1) {
                    ketqua.push(chuSo[chuc], "mươi");
                    if (donvi === 1) {
                        ketqua.push("mốt");
                    } else if (donvi > 1) {
                        ketqua.push(chuSo[donvi]);
                    }
                } else if (chuc === 1) {
                    ketqua.push("mười");
                    if (donvi === 5) {
                        ketqua.push("lăm");
                    } else if (donvi > 0) {
                        ketqua.push(chuSo[donvi]);
                    }
                } else if (donvi > 0) {
                    // *** THAY ĐỔI CHÍNH Ở ĐÂY ***
                    // Chỉ thêm "linh" nếu không phải là nhóm đầu tiên, HOẶC nếu nhóm đầu tiên có hàng trăm
                    // Ví dụ: 9.000.000 -> isFirstGroup=true, tram=0 => không thêm "linh"
                    // Ví dụ: 104.000.000 -> isFirstGroup=true, tram=1 => thêm "linh" (một trăm linh bốn)
                    if (!isFirstGroup || tram > 0) {
                        ketqua.push("linh");
                    }
                    ketqua.push(chuSo[donvi]);
                }
                
                return ketqua;
            }

            if (sotien == null || sotien === '' || isNaN(sotien)) return "";
            if (Number(sotien) === 0) return "Không";
            
            let soStr = String(Math.floor(Math.abs(Number(sotien))));
            if (soStr.length > 18) return "Số quá lớn";

            let cacNhom = [];
            while (soStr.length > 0) {
                cacNhom.push(soStr.slice(Math.max(soStr.length - 3, 0)));
                soStr = soStr.slice(0, Math.max(soStr.length - 3, 0));
            }
            if (cacNhom.length === 0) return "";

            let ketquaFinal = [];
            for (let i = cacNhom.length - 1; i >= 0; i--) {
                let nhom = parseInt(cacNhom[i], 10);
                if (nhom === 0) continue;
                
                // *** THAY ĐỔI CHÍNH Ở ĐÂY ***
                // Xác định xem đây có phải là nhóm số đầu tiên được xử lý hay không
                const isFirstGroup = ketquaFinal.length === 0;
                let chuoiNhom = docNhomBaChuSo(nhom, isFirstGroup);

                // Bỏ đoạn mã if bị lỗi và không cần thiết ở đây

                if (chuoiNhom.length > 0) {
                     ketquaFinal.push(...chuoiNhom, hang[i]);
                }
            }
            
            let ketquaStr = ketquaFinal.join(" ").trim();
            if (ketquaStr.endsWith(hang[0])) {
                ketquaStr = ketquaStr.slice(0, ketquaStr.length - hang[0].length).trim();
            }

            // Viết hoa chữ cái đầu
            return ketquaStr.charAt(0).toUpperCase() + ketquaStr.slice(1);
        }

        function generateVietQR(bankName, accountNumber, amount, description, accountName) { const qrImgElement = document.getElementById('vietqr_code_small'); if (!bankName || !accountNumber || !qrImgElement) { if(qrImgElement) qrImgElement.style.display = 'none'; return; } const cleanBankName = (bankName || '').toLowerCase().replace(/\s/g, ''); const bankBin = BANK_BINS[cleanBankName]; if (!bankBin) { console.error('Không tìm thấy mã BIN cho ngân hàng:', bankName); qrImgElement.style.display = 'none'; return; } const cleanAmount = String(amount || '0').replace(/[.,]/g, ''); const addInfo = encodeURIComponent(description || ''); const accName = encodeURIComponent(accountName || ''); const qrUrl = `https://api.vietqr.io/image/${bankBin}-${accountNumber}-G4l0bO1.jpg?amount=${cleanAmount}&addInfo=${addInfo}&accountName=${accName}`; qrImgElement.src = qrUrl; }
        
        function populateData() {
            const dataParam = getQueryParam('data'); 
            let data = {};

            if (dataParam) {
                try {
                    const decodedParam = decodeURIComponent(dataParam);
                    const sanitizedJsonString = decodedParam.replace(/(?<!\\)\n/g, '\\n');
                    data = JSON.parse(sanitizedJsonString);
                } catch (e) {
                    console.error("Lỗi JSON, không thể đọc dữ liệu từ URL:", e);
                }
            }
            
            const fill = (id, value, isHtml = false) => { const el = document.getElementById(id); if (el) { if (isHtml) el.innerHTML = (value || '').replace(/\\n/g, '<br>'); else el.textContent = value || ''; } };
            const fillAttr = (id, attr, value) => { const el = document.getElementById(id); if (el) el.setAttribute(attr, value || ''); };
            const formatInteger = (num) => { return num != null ? new Intl.NumberFormat('de-DE').format(Math.round(num)) : ''; };
            const formatDecimal = (num) => { return num != null ? new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num) : ''; };
            
            fill('company_name', data.company_name); 
            fill('company_address', data.company_address, true); 
            fill('company_phone', data.company_phone); 
            fill('company_email', data.company_email);
            fill('company_tax_code', data.company_tax_code);
            
            let zaloLink = data.company_zalo_link || '';
            let displayZalo = zaloLink.replace(/https?:\/\//, '');
            if (zaloLink && !zaloLink.startsWith('http')) {
                zaloLink = 'https://' + zaloLink;
            }
            fillAttr('company_zalo_link', 'href', zaloLink);
            document.getElementById('company_zalo_link').textContent = displayZalo;
            
            fill('so_dh', data.so_dh); 
            fill('ngay_lap', data.ngay_lap); 
            
            const customerProjectLine = document.getElementById('ten_du_an_line');
            if (data.ten_du_an && data.ten_du_an.trim() !== '') {
                fill('ten_du_an', "Dự án: " + data.ten_du_an);
                customerProjectLine.style.display = 'block';
            } else {
                customerProjectLine.style.display = 'none';
            }

            fill('ten_kh', data.ten_kh); 
            fill('tax_code', data.tax_code, true);
            const contactParts = []; if (data.customer_contact_person) { contactParts.push(`<strong>${data.customer_contact_person}</strong>`); } if (data.customer_phone) { contactParts.push(`SĐT: ${data.customer_phone}`); } if (data.customer_email) { contactParts.push(`Email: ${data.customer_email}`); } fill('contact_line', contactParts.join(' &nbsp;|&nbsp; '), true);
            
            fill('subtotal', formatInteger(data.subtotal)); 
            fill('vat_amount', formatInteger(data.vat_amount)); 
            fill('grand_total', formatInteger(data.grand_total));
            const amountInNumber = String(data.grand_total || '0').replace(/[.,]/g, '');
            if (parseInt(amountInNumber) > 0) {
                const amountInWords = docso(amountInNumber);
                fill('grand_total_in_words', `<i><b>(Bằng chữ: ${amountInWords} đồng).</b></i>`, true);
            } else {
                 fill('grand_total_in_words', '');
            }
            
            fill('notes_and_terms', data.notes_and_terms, true);
            fill('company_name_signature', data.company_name); 
            const stampImg = document.getElementById('company_stamp'); if (data.company_branch_code && stampImg) { const signatureUrl = GITHUB_SIGNATURE_BASE_URL + data.company_branch_code + ".jpg?raw=true"; stampImg.src = signatureUrl; }
            
            fill('bank_account_name', data.bank_account_name); 
            fill('bank_account_number', data.bank_account_number); 

            const originalShortBankName = data.bank_name || '';
            const shortBankNameKey = originalShortBankName.toLowerCase().replace(/\s/g, '');
            const fullBankName = BANK_FULL_NAMES[shortBankNameKey] || originalShortBankName;
            fill('bank_name', fullBankName);

            let paymentText = data.payment_reference_text || '';
            if (originalShortBankName) {
                const regex = new RegExp(originalShortBankName, 'gi');
                paymentText = paymentText.replace(regex, fullBankName);
            }
            fill('payment_reference_text', paymentText);
            
            const tableBody = document.getElementById('product_table_body'); tableBody.innerHTML = '';
            (data.products || []).forEach((item, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = item.ten_sanpham;
                row.insertCell(2).textContent = item.dvt;
                row.insertCell(3).textContent = formatDecimal(item.so_luong);
                row.insertCell(4).textContent = formatInteger(item.don_gia);
                row.insertCell(5).textContent = formatInteger(item.thanh_tien);
                const vatPercent = ((item.thue_vat_rate || 0) * 100);
                row.insertCell(6).textContent = `${vatPercent}%`;
            });
            
            generateVietQR(data.bank_name, data.bank_account_number, data.grand_total, `TT BG ${data.so_dh || ''}`, data.bank_account_name);
        }
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
