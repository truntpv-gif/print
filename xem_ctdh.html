<!DOCTYPE html>
<html>
<head>
    <title>THÔNG TIN XUẤT HÓA ĐƠN</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS CHUNG & BỐ CỤC */
        body { background-color: #fff; margin: 0; padding: 0; font-family: 'Times New Roman', Times, serif; font-size: 11pt; }
        .page { width: 21cm; min-height: 29.7cm; padding: 1.2cm; margin: 1cm auto; border: 1px #D3D3D3 solid; background: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; display: flex; flex-direction: column; }
        
        @page { 
            size: A4; 
            margin: 10mm; 
        }
        
        @media print { 
            html, body { 
                width: 21cm; 
            } 
            .page { 
                margin: 0; 
                border: initial; 
                box-shadow: initial; 
                background: initial; 
            } 
            .print-button-container { display: none; } 
        }
        .print-button-container { position: fixed; top: 10px; right: 10px; z-index: 100; }
        .print-button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }

        /* THÔNG TIN KHÁCH HÀNG & TIÊU ĐỀ */
        .title-section { text-align: center; margin: 20px 0; padding-top: 50px; }
        .title-section h1 { font-size: 18pt; margin: 0; }
        .title-section p { margin: 5px 0; font-size: 11pt; }
        .customer-info { margin-bottom: 10px; line-height: 1.5; }
        .customer-info table { border-collapse: collapse; width: 100%; }
        .customer-info td { padding: 1px 5px; vertical-align: top; }
        .customer-info td:first-child { width: 100px; }
        .intro-line { margin-top: 0; margin-bottom: 10px; }

        /* BẢNG SẢN PHẨM & TỔNG CỘNG */
        table.products { width: 100%; border-collapse: collapse; font-size: 11pt; }
        table.products thead th, table.products tbody td, table.products tfoot td { border: 1px solid #000; padding: 6px; }
        table.products thead th { background-color: #e0e0e0; font-weight: bold; text-align: center; }
        table.products tbody td:nth-child(1), table.products tbody td:nth-child(3) { text-align: center; }
        table.products tbody td:nth-child(4), table.products tbody td:nth-child(5), table.products tbody td:nth-child(6) { text-align: right; }
        
        table.products tfoot td { border-top: none; font-weight: bold; padding: 6px 8px; }
        .totals-label-cell { text-align: right; }
        .totals-value-cell { text-align: right; }
        
        /* GHI CHÚ, CHỮ KÝ, THANH TOÁN */
        .notes-block { margin-top: 10px; font-size: 10pt; }
        .notes-block p { margin: 0; padding-left: 10px; font-style: italic; }

        .final-section-group {
            page-break-inside: avoid;
            margin-top: 30px; 
        }

        /* MÀU SẮC DỮ LIỆU ĐỘNG */
        #so_dh, #ngay_lap, #ten_kh, #company_name,
        #subtotal, #vat_amount, #grand_total, #notes_and_terms, #company_name_signature, #company_tax_code, #ten_du_an, #tax_code, #tax_email {
            color: #002B5B;
        }
    </style>
</head>
<body>
    <div class="print-button-container"><button class="print-button" onclick="window.print()">In Báo Giá</button></div>
    <div class="page">
        
        <div class="title-section">
            <h1>THÔNG TIN XUẤT HÓA ĐƠN</h1>
            <p>Đơn vị xuất HD: <strong id="company_name"></strong></p>
            <p>Số: <strong id="so_dh"></strong> &nbsp;|&nbsp; Ngày: <span id="ngay_lap"></span></p>
        </div>

        <div class="customer-info"><table>
            <tr><td>Khách hàng</td><td>: <strong id="ten_kh"></strong></td></tr>
            <tr><td>MST</td><td>: <span id="tax_code"></span></td></tr>
            <tr><td>Email nhận HĐ</td><td>: <span id="tax_email"></span></td></tr>
            <tr><td>Dự án </td><td>: <span id="ten_du_an"></span></td></tr>
        </table></div>
        <p class="intro-line">Chi tiết đơn hàng.</p>
        
        <table class="products">
            <thead><tr><th style="width: 5%;">Stt</th><th style="width: 35%;">Tên sản phẩm</th><th style="width: 8%;">Đvt</th><th style="width: 10%;">Số lượng</th><th style="width: 14%;">Đơn giá<br>(chưa VAT)</th><th style="width: 14%;">Thành tiền<br>(chưa VAT)</th><th style="width: 10%;">Thuế VAT</th></th></thead>
            <tbody id="product_table_body"></tbody>
            <tfoot>
                <tr><td colspan="5" class="totals-label-cell">Tổng thành Tiền:</td><td class="totals-value-cell" colspan="2"><span id="subtotal"></span></td></tr>
                <tr><td colspan="5" class="totals-label-cell">Thuế VAT:</td><td class="totals-value-cell" colspan="2"><span id="vat_amount"></span></td></tr>
                <tr><td colspan="5" class="totals-label-cell">Tổng tiền đơn hàng:</td><td class="totals-value-cell" colspan="2"><span id="grand_total"></span></td></tr>
            </tfoot>
        </table>

        <div class="notes-block"><strong></strong><p id="notes_and_terms"></p></div>
        
        <div class="final-section-group">
            <div class="payment-section"></div>
        </div>
    </div>

    <script>
        function getQueryParam(param) { return new URLSearchParams(window.location.search).get(param); }
        
        function populateData() {
            const dataParam = getQueryParam('data'); 
            let data = {};

            if (dataParam) {
                try {
                    const decodedParam = decodeURIComponent(dataParam);
                    const sanitizedJsonString = decodedParam.replace(/(?<!\\)\n/g, '\\n');
                    data = JSON.parse(sanitizedJsonString);
                } catch (e) {
                    console.error("Lỗi JSON, không thể đọc dữ liệu từ URL:", e);
                }
            }
            
            const fill = (id, value) => { const el = document.getElementById(id); if (el) { el.textContent = value || ''; } };
            const formatInteger = (num) => { return num != null ? new Intl.NumberFormat('de-DE').format(Math.round(num)) : ''; };
            const formatDecimal = (num) => { return num != null ? new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num) : ''; };
            
            // Điền thông tin vào các vị trí mới
            fill('company_name', data.company_name); 
            fill('so_dh', data.so_dh); 
            fill('ngay_lap', data.ngay_lap); 
            
            // Điền thông tin khách hàng
            fill('ten_kh', data.ten_kh); 
            fill('tax_code', data.tax_code);
            fill('tax_email', data.tax_email);
            fill('ten_du_an', data.ten_du_an); 

            // ===== CÁC DÒNG NÀY SẼ ĐIỀN DỮ LIỆU TỔNG TIỀN =====
            // Chúng lấy giá trị từ data.subtotal, data.vat_amount, data.grand_total trong JSON
            fill('subtotal', formatInteger(data.subtotal)); 
            fill('vat_amount', formatInteger(data.vat_amount)); 
            fill('grand_total', formatInteger(data.grand_total));
            
            // Điền ghi chú
            const notesEl = document.getElementById('notes_and_terms');
            if(notesEl) notesEl.innerHTML = (data.notes_and_terms || '').replace(/\\n/g, '<br>');
            
            // Điền bảng sản phẩm
            const tableBody = document.getElementById('product_table_body'); tableBody.innerHTML = '';
            (data.products || []).forEach((item, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = item.ten_sanpham;
                row.insertCell(2).textContent = item.dvt;
                row.insertCell(3).textContent = formatDecimal(item.so_luong);
                row.insertCell(4).textContent = formatInteger(item.don_gia);
                row.insertCell(5).textContent = formatInteger(item.thanh_tien);
                const vatPercent = ((item.thue_vat_rate || 0) * 100);
                row.insertCell(6).textContent = `${vatPercent}%`;
            });
        }
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
