<!DOCTYPE html>
<html>
<head>
    <title>PHIẾU GIAO HÀNG</title>
    <style>
        @page {
            size: A4;
            margin: 0;
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 2cm;
            box-sizing: border-box;
            position: relative;
        }

        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px;
            color: rgba(0, 0, 0, 0.1);
            z-index: -1;
            white-space: nowrap;
            pointer-events: none;
            display: none; /* Hidden by default, shown if demo data is used */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .company-info {
            font-size: 11px;
            line-height: 1.4;
            width: 60%;
        }

        .company-info strong {
            font-size: 13px;
        }

        .logo {
            width: 150px; /* Adjusted for the new logo, you might need to fine-tune */
            height: auto;
        }

        .delivery-note-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 5px;
        }

        .date {
            text-align: center;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .customer-info {
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .customer-info div {
            display: flex;
        }

        .customer-info div span:first-child {
            width: 120px;
            flex-shrink: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 50px;
            font-size: 12px;
        }

        table th, table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }

        table th {
            background-color: #f2f2f2;
            text-align: center;
        }

        .signatures {
            display: flex;
            justify-content: space-around;
            text-align: center;
            font-size: 12px;
        }

        .signature-block {
            width: 40%;
        }

        .signature-block p {
            margin-bottom: 60px; /* Space for signature */
        }

        .print-button-container {
            text-align: right;
            margin-bottom: 20px;
            /* Only show button on screen, hide when printing */
            @media print {
                display: none;
            }
        }
        .print-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="watermark" id="watermark">PHIẾU GIAO HÀNG DEMO</div>

    <div class="print-button-container">
        <button class="print-button" onclick="window.print()">In Phiếu Giao Hàng</button>
    </div>

    <div class="header">
        <div class="company-info">
            <strong>CN CÔNG TY TNHH XD TÍN THỊNH</strong><br>
            Địa chỉ: Số 8/13, Đường số 16, P. Bình Hưng Hòa, TP HCM<br>
            VP MT: Khối 3, phường Điện Bàn, TP Đà Nẵng<br>
            VP MB: số 117 Trần Duy Hưng, P. Trung Hòa, TP Hà Nội.<br>
            ĐT: 0933 676 123<br>
            Zalo OA: Siêu Thị Vật Tư (<a href="https://zalo.me/sieuthivattu">zalo.me/sieuthivattu</a>)<br>
            Email: vattutinthinh@gmail.com
        </div>
        <img src="https://theme.hstatic.net/1000375557/1001056558/14/logo.png?v=439" alt="SIÊU THỊ VẬT TƯ.COM Logo" class="logo">
    </div>

    <p class="delivery-note-title">PHIẾU GIAO HÀNG</p>
    <p class="date">Ngày: <span id="deliveryDate"></span></p>

    <div class="customer-info">
        <div><span>Khách hàng</span> : <span id="customerName"></span></div>
        <div><span>Dự án</span> : <span id="projectName"></span></div>
        <div><span>Địa chỉ nhận hàng</span> : <span id="deliveryAddress"></span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>STT</th>
                <th>TÊN VẬT TƯ</th>
                <th>ĐƠN VỊ</th>
                <th>SỐ LƯỢNG</th>
                <th>GHI CHÚ</th>
            </tr>
        </thead>
        <tbody id="itemTableBody">
            <!-- Items will be inserted here by JavaScript -->
        </tbody>
    </table>

    <div class="signatures">
        <div class="signature-block">
            <p>Người nhận hàng</p>
            <p>(Ký tên)</p>
        </div>
        <div class="signature-block">
            <p>Người lập</p>
            <p>(Ký tên)</p>
        </div>
    </div>

    <script>
        // Function to get query parameters
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                if (parts[0]) {
                    params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
                }
            });
            return params;
        }

        // Function to populate data
        function populateData() {
            const params = getQueryParams();
            let isDemo = true;

            // Populate header info
            document.getElementById('deliveryDate').textContent = params.deliveryDate || '01/09/2025';
            document.getElementById('customerName').textContent = params.customerName || 'CÔNG TY CỔ PHẦN THIẾT BỊ VÀ CÔNG NGHỆ XÂY DỰNG KEY GROUP';
            document.getElementById('projectName').textContent = params.projectName || 'STVT';
            document.getElementById('deliveryAddress').textContent = params.deliveryAddress || '';

            // Populate table items
            const itemTableBody = document.getElementById('itemTableBody');
            let items = [];

            // Process json_detail parameter
            if (params.json_detail) {
                try {
                    const parsedDetails = JSON.parse(params.json_detail);
                    // AppSheet might pass an array of JSON strings, or a single JSON array string
                    if (Array.isArray(parsedDetails)) {
                        // If it's an array of JSON objects (e.g., from SELECT(..., TRUE))
                        items = parsedDetails.map(detail => {
                            if (typeof detail === 'string') { // If elements are still JSON strings
                                try { return JSON.parse(detail); } catch (e) { return null; }
                            }
                            return detail;
                        }).filter(item => item !== null);
                    } else if (typeof parsedDetails === 'object') {
                         // If it's a single JSON object (e.g., if only one item is passed)
                         items = [parsedDetails];
                    }
                    if (items.length > 0) isDemo = false;
                } catch (e) {
                    console.error("Error parsing json_detail:", e);
                    // Fallback to demo if parsing fails
                }
            }

            if (items.length === 0) { // If no data from URL or parsing failed, use demo data
                items = [
                    { ten_sanpham: 'Matit gắn thép Ramset Epcon G5', dvt: 'Chai', so_luong: 30, ghi_chu: '' },
                    { ten_sanpham: 'Súng bắn keo Ramset', dvt: 'Cái', so_luong: 2, ghi_chu: '' },
                    { ten_sanpham: 'Miễn phí vận chuyển', dvt: 'Chuyến', so_luong: 1, ghi_chu: '' }
                ];
                isDemo = true;
            } else {
                isDemo = false;
            }

            items.forEach((item, index) => {
                const row = itemTableBody.insertRow();
                row.insertCell(0).textContent = index + 1; // Auto-generated STT
                row.insertCell(1).textContent = item.ten_sanpham;
                row.insertCell(2).textContent = item.dvt;
                row.insertCell(3).textContent = item.so_luong;
                row.insertCell(4).textContent = item.ghi_chu;
            });

            // Show watermark if using demo data
            if (isDemo) {
                document.getElementById('watermark').style.display = 'block';
            }
        }

        // Run when the page loads
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
